# Copilot Instructions — Workflow Orchestration POC

## Project Overview

Monorepo to evaluate orchestration frameworks via invoice processing. Azure Durable Functions is implemented in `azure-durable-functions`; Temporal and AWS Step Functions are planned.

## Quick Start

```powershell
cd azure-durable-functions
uv sync
azurite --silent --location . --debug ./azurite.log
uv run func host start -p 8071
curl http://localhost:8071/api/startup
```

## Conventions

- **Activities**: `activities/<name>.py`; `<snake_case>_activity`; `@blueprint.activity_trigger(input_name="payload")`; return JSON-serializable dict; log with `[ACTIVITY:NAME]`.
- **Orchestrator**: `function_app.py` → deterministic; use `yield context.call_activity(...)`; fan-out via list of calls; fan-in with `yield context.task_all(tasks)`; no I/O, randomness, or `datetime.now()`.
- **Storage**: Use `storage_helper.py`; containers `pdfs` (input) and `images` (outputs); names `{invoice_id}.pdf`, `{pdf_id}/page_{n}.png`; ensure containers exist.
- **HTTP**: Endpoints `/api/<resource>/<action>`; e.g., `/api/invoice/process`, `/api/startup`; return JSON with `instanceId`.

## Testing

```powershell
uv run python tools/test_function.py --base-url http://localhost:8071
uv run python tools/load_test.py --pdf-path data/sample-invoice.pdf
```

## Rules

- **Footer**: Always append current date/time in short format (e.g., 12/20/2025 2:30 PM).
- **Style**: Be concise, direct, and friendly; prefer bullets over long prose.
- **Determinism**: Orchestrator must remain pure; avoid side effects and non-determinism.
- **Local-first**: Use Azurite; avoid cloud operations by default in local runs.
- **Outputs**: Activities must return JSON-serializable dicts and use the `[ACTIVITY:NAME]` log prefix.

## References

- [Azure Durable Functions Docs](https://learn.microsoft.com/en-us/azure/azure-functions/durable/)
- [Azure Functions Blueprint Pattern](https://learn.microsoft.com/en-us/azure/azure-functions/functions-reference-python?tabs=asgi%2Cazure-cli-set-default-subscription#bp-support)
- [Comparison Matrix](./docs/comparison-matrix.md) (ADF vs alternatives)
- [ADF SPEC.md](./azure-durable-functions/SPEC.md) (Technical details)
