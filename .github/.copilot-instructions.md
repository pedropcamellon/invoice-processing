# Copilot Instructions for Workflow Orchestration POC

## Project Overview

**workflow-orchestration-poc** is a monorepo for evaluating and comparing orchestration frameworks using invoice processing as a reference implementation.

### Purpose
This is a **learning/evaluation project** (not production code) designed to:
- Compare orchestration frameworks side-by-side
- Provide a decision-making reference
- Demonstrate patterns and best practices
- Support work presentations with concrete examples

### Repository Structure

```
workflow-orchestration-poc/
â”œâ”€â”€ README.md                          # Main monorepo overview
â”œâ”€â”€ docs/
â”‚   â””â”€â”€ comparison-matrix.md           # Framework comparison (ADF vs Temporal vs Step Functions)
â”œâ”€â”€ azure-durable-functions/           # âœ… Azure Durable Functions implementation
â”‚   â”œâ”€â”€ README.md                      # Setup & architecture
â”‚   â”œâ”€â”€ SPEC.md                        # Technical specifications
â”‚   â”œâ”€â”€ function_app.py                # Orchestrator & HTTP triggers
â”‚   â”œâ”€â”€ storage_helper.py              # Blob storage utilities
â”‚   â”œâ”€â”€ activities/                    # Activity blueprints
â”‚   â”‚   â”œâ”€â”€ upload_pdf.py
â”‚   â”‚   â”œâ”€â”€ split_pdf.py
â”‚   â”‚   â”œâ”€â”€ extract_invoice.py
â”‚   â”‚   â””â”€â”€ aggregate_invoice.py
â”‚   â”œâ”€â”€ api_bruno/                     # API test collection
â”‚   â”œâ”€â”€ data/                          # Sample PDFs
â”‚   â”œâ”€â”€ tools/                         # Test & load test scripts
â”‚   â”œâ”€â”€ pyproject.toml                 # Dependencies
â”‚   â”œâ”€â”€ host.json                      # Runtime config
â”‚   â””â”€â”€ local.settings.json            # Dev settings
â”œâ”€â”€ temporal/                          # ðŸ”„ [Planned] Temporal implementation
â””â”€â”€ aws-step-functions/                # ðŸ”„ [Planned] Step Functions implementation
```

## Development Workflow

### For Azure Durable Functions

#### Prerequisites
- Python 3.11+ with `uv` package manager
- Azure Functions Core Tools v4
- Azurite storage emulator (`npm install -g azurite`)

#### Quick Start (from root directory)
```powershell
cd azure-durable-functions
uv sync

# Terminal 1: Start Azurite
azurite --silent --location . --debug ./azurite.log

# Terminal 2: Start function app
uv run func host start -p 8071

# Terminal 3: Initialize storage
curl http://localhost:8071/api/startup
```

#### Project Structure
- **Orchestrator**: `function_app.py` â†’ `invoice_orchestrator` (must be deterministic!)
- **Activities**: Each in separate file under `activities/`
- **Blueprint Pattern**: All activity blueprints registered in `function_app.py`
- **Storage**: Uses Azurite (local blob storage emulator)
- **Testing**: Bruno API collections in `api_bruno/`

#### Key Concepts
- **Determinism**: Orchestrator code must be pure (no I/O, randomness, datetime.now())
- **Replay**: ADF replays orchestrator from history for durability
- **Fan-out/Fan-in**: Parallel activity execution with `context.task_all()`
- **Activities**: Modular units of work (can have side effects)

#### Common Commands
```powershell
# Run tests
uv run python tools/test_function.py --base-url http://localhost:8071

# Load test
uv run python tools/load_test.py --pdf-path data/sample-invoice.pdf

# Add dependency
uv add <package-name>

# Sync dependencies
uv sync
```

## Code Conventions

### Activity Functions
- Location: `activities/<name>.py`
- Function name: `<snake_case>_activity` (e.g., `upload_pdf_activity`)
- Decorator: `@blueprint.activity_trigger(input_name="payload")`
- Signature: `def activity_name(payload: Dict[str, Any]) -> Dict[str, Any]:`
- Logging: Use `[ACTIVITY:NAME]` prefix
- Must return JSON-serializable dict

### Orchestrator Function
- Location: `function_app.py`
- Must be **deterministic** (pure function)
- Call activities with: `yield context.call_activity()`
- Fan-out: `tasks = [context.call_activity(...) for x in items]`
- Fan-in: `results = yield context.task_all(tasks)`
- No I/O, randomness, or datetime.now() in orchestrator code

### Storage Operations
- Helper module: `storage_helper.py`
- Containers: `pdfs` (input), `images` (outputs)
- Naming convention: `{invoice_id}.pdf`, `{pdf_id}/page_{n}.png`
- Always check container existence before operations

### HTTP Triggers
- Location: `function_app.py`
- Endpoint pattern: `/api/<resource>/<action>`
- Examples: `/api/invoice/process`, `/api/startup`
- Return: JSON response with `instanceId` (for async tracking)

## Comparison Matrix

For framework comparison details, see [docs/comparison-matrix.md](./docs/comparison-matrix.md):
- Azure Durable Functions vs Temporal vs Step Functions vs Dapr
- Performance metrics, operational complexity, cost analysis
- Use case recommendations and decision framework

## When Adding New Patterns

1. Create subdirectory: `<framework-name>/`
2. Implement same invoice processing workflow
3. Create `README.md` with setup instructions
4. Create `SPEC.md` with technical details
5. Update `docs/comparison-matrix.md` with findings

## Testing & Validation

- **API Tests**: `api_bruno/` collection for manual testing
- **Verification Script**: `tools/test_function.py` for endpoint checks
- **Load Testing**: `tools/load_test.py` for throughput validation
- **Sample Data**: `data/sample-invoice.pdf` for testing

## References

- [Azure Durable Functions Docs](https://learn.microsoft.com/en-us/azure/azure-functions/durable/)
- [Azure Functions Blueprint Pattern](https://learn.microsoft.com/en-us/azure/azure-functions/functions-reference-python?tabs=asgi%2Cazure-cli-set-default-subscription#bp-support)
- [Comparison Matrix](./docs/comparison-matrix.md) (ADF vs alternatives)
- [ADF SPEC.md](./azure-durable-functions/SPEC.md) (Technical details)
